# RLSポリシー適用手順

## 🎯 目的

Supabaseセキュリティアドバイザーの12個のエラーを解消します。

---

## 📋 実行前の確認

### ✅ チェックリスト

- [ ] Supabaseダッシュボードにアクセス可能
- [ ] プロジェクト: `takutoh-baseball-system` を選択済み
- [ ] データベースのバックアップ（念のため）

---

## 🚀 実行手順

### 1. Supabaseダッシュボードを開く

1. [Supabase Dashboard](https://supabase.com/dashboard) にアクセス
2. `takutoh-baseball-system` プロジェクトを選択
3. 左メニューから「**SQL Editor**」をクリック

### 2. SQLファイルを実行

1. `enable-rls-policies.sql` の内容をコピー
2. SQL Editorに貼り付け
3. **「Run」ボタン**をクリック

### 3. 実行結果の確認

以下のメッセージが表示されればOK：

```
✅ RLSポリシーの設定が完了しました！
すべてのテーブルでRLSが有効化され、Supabaseのセキュリティエラーが解消されます。
PINベース認証のため、全ユーザーにフルアクセス権限が付与されています。
```

---

## 🔍 動作確認

### 確認クエリ1: RLS有効状態の確認

```sql
SELECT 
  tablename,
  rowsecurity as rls_enabled
FROM pg_tables 
WHERE schemaname = 'public'
AND tablename IN (
  'app_users', 'events', 'participations', 
  'expenses', 'expense_categories', 'expense_subcategories',
  'quick_expenses', 'game_records', 'files', 'recurring_patterns'
)
ORDER BY tablename;
```

**期待される結果**: すべて `rls_enabled = true`

### 確認クエリ2: ポリシー数の確認

```sql
SELECT 
  tablename,
  COUNT(*) as policy_count
FROM pg_policies
WHERE schemaname = 'public'
GROUP BY tablename
ORDER BY tablename;
```

**期待される結果**: 各テーブルに4つのポリシー（SELECT, INSERT, UPDATE, DELETE）

---

## 📱 アプリケーション動作確認

1. **ログインテスト**
   - 管理者（PIN: 9999）でログイン
   - 一般ユーザーでログイン

2. **機能テスト**
   - イベント閲覧
   - 参加状況登録
   - 経費申請
   - ファイルアップロード

すべて正常に動作すればOKです！

---

## ⚠️ トラブルシューティング

### エラー: `policy "xxx" already exists`

**原因**: 既にポリシーが存在する

**対処法**: 既存のポリシーを削除してから再実行

```sql
-- 例: app_usersテーブルのポリシーを削除
DROP POLICY IF EXISTS "app_users_select_policy" ON app_users;
DROP POLICY IF EXISTS "app_users_insert_policy" ON app_users;
DROP POLICY IF EXISTS "app_users_update_policy" ON app_users;
DROP POLICY IF EXISTS "app_users_delete_policy" ON app_users;
```

### エラー: `view "xxx" already exists`

**原因**: ビューが既に存在する（正常）

**対処法**: SQLは`DROP VIEW IF EXISTS`を含んでいるので無視してOK

### アプリケーションが動かない

1. ブラウザのキャッシュをクリア
2. ログアウト→ログイン
3. Supabaseのログを確認（Dashboard > Logs）

---

## 📊 セキュリティアドバイザーの確認

### 最終確認

1. Supabaseダッシュボードを開く
2. 左メニュー「**Database**」→「**Advisors**」をクリック
3. エラー数が0になっていることを確認

**または、メールで送られてくる週次レポートで確認できます。**

---

## 📞 サポート

問題が発生した場合は、以下の情報を確認してください：

1. 実行したSQLファイルのバージョン
2. エラーメッセージの全文
3. Supabaseのバージョン

詳細は `RLS-POLICIES-README.md` を参照してください。

---

## ✨ 完了！

お疲れさまでした！これでSupabaseのセキュリティエラーが解消されました。

今後、より厳格なセキュリティが必要になった場合は、Supabase認証への移行を検討してください。
